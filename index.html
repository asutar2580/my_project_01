<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>소유권이전등기신청서 자동작성기</title>
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://unpkg.com/@pdf-lib/fontkit@1.1.1/dist/fontkit.umd.min.js"></script>
  <script src="https://unpkg.com/downloadjs@1.4.7"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: "Malgun Gothic", "맑은 고딕", sans-serif;
      background: #f5f5f5;
      color: #333;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .header {
      padding: 16px 24px;
      background: #fff;
      border-bottom: 1px solid #e0e0e0;
      flex-shrink: 0;
    }
    .header h1 {
      margin: 0;
      font-size: 1.35rem;
      color: #1a56db;
      font-weight: 700;
    }
    .main {
      flex: 1;
      display: flex;
      min-height: 0;
    }
    .form-panel {
      width: 40%;
      min-width: 320px;
      background: #fff;
      border-right: 1px solid #e0e0e0;
      overflow-y: auto;
      padding: 20px;
    }
    .form-panel h2 {
      margin: 0 0 12px;
      font-size: 1rem;
      color: #1a56db;
      border-bottom: 2px solid #1a56db;
      padding-bottom: 6px;
    }
    .form-section { margin-bottom: 20px; }
    .form-group { margin-bottom: 12px; }
    .form-group label {
      display: block;
      font-size: 0.8rem;
      color: #555;
      margin-bottom: 4px;
    }
    .form-group input {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.9rem;
    }
    .form-group input:focus {
      outline: none;
      border-color: #1a56db;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
    }
    .preview-panel {
      width: 60%;
      min-width: 0;
      background: #888;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .preview-panel iframe {
      width: 100%;
      height: 100%;
      min-height: 500px;
      border: none;
      background: #fff;
      border-radius: 4px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.2);
    }
    .preview-placeholder {
      color: #fff;
      font-size: 0.95rem;
      text-align: center;
      padding: 20px;
    }
    .footer {
      padding: 16px 24px;
      background: #fff;
      border-top: 1px solid #e0e0e0;
      flex-shrink: 0;
      text-align: center;
    }
    .btn-download {
      padding: 14px 48px;
      font-size: 1.05rem;
      font-weight: 600;
      background: #1a56db;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .btn-download:hover { background: #1544b0; }
    .btn-download:disabled {
      background: #999;
      cursor: not-allowed;
    }
    .file-upload-wrap {
      margin-bottom: 16px;
      padding: 12px;
      border: 2px dashed #ccc;
      border-radius: 8px;
      background: #fafafa;
    }
    .file-upload-wrap label {
      display: block;
      font-size: 0.85rem;
      color: #555;
      margin-bottom: 6px;
    }
    .file-upload-wrap input[type=file] {
      font-size: 0.85rem;
    }
    .file-hint {
      margin: 0 0 8px;
      font-size: 0.8rem;
      color: #666;
    }
    .ai-section {
      margin-bottom: 20px;
      padding: 16px;
      background: #f0fdf4;
      border: 1px solid #16a34a;
      border-radius: 8px;
    }
    .ai-section label {
      display: block;
      font-size: 0.85rem;
      color: #166534;
      margin-bottom: 6px;
      font-weight: 600;
    }
    .ai-section input[type=password] {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #16a34a;
      border-radius: 6px;
      font-size: 0.9rem;
      margin-bottom: 12px;
    }
    .ai-section textarea {
      width: 100%;
      min-height: 100px;
      padding: 10px;
      border: 1px solid #16a34a;
      border-radius: 6px;
      font-size: 0.9rem;
      resize: vertical;
      margin-bottom: 10px;
      font-family: inherit;
    }
    .ai-section textarea:focus {
      outline: none;
      border-color: #15803d;
      box-shadow: 0 0 0 2px rgba(22, 163, 74, 0.2);
    }
    .btn-ai-fill {
      padding: 10px 20px;
      font-size: 0.95rem;
      font-weight: 600;
      background: #16a34a;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .btn-ai-fill:hover { background: #15803d; }
    .btn-ai-fill:disabled {
      background: #86efac;
      cursor: not-allowed;
    }
    .ai-spinner {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 2px solid rgba(255,255,255,0.4);
      border-top-color: #fff;
      border-radius: 50%;
      animation: ai-spin 0.8s linear infinite;
    }
    @keyframes ai-spin { to { transform: rotate(360deg); } }
    .ai-message {
      margin-top: 10px;
      font-size: 0.85rem;
      min-height: 20px;
    }
    .ai-message.success { color: #15803d; }
    .ai-message.error { color: #b91c1c; }
    @media (max-width: 900px) {
      .main { flex-direction: column; }
      .form-panel { width: 100%; max-height: 45%; }
      .preview-panel { width: 100%; min-height: 50%; }
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>소유권이전등기신청서 자동작성기</h1>
  </header>

  <main class="main">
    <div class="form-panel">
      <div class="ai-section">
        <label for="apiKey">Anthropic API 키</label>
        <input type="password" id="apiKey" placeholder="sk-ant-api..." autocomplete="off">
        <label for="aiInput">거래 내용 (자연어)</label>
        <textarea id="aiInput" rows="5" placeholder="거래 내용을 자유롭게 입력하세요. 예: 서울 강남구 역삼동 123 대지 100㎡, 2024년 3월 15일 매매계약, 매도인 홍길동(주민번호 800101-1234567), 매수인 김철수..."></textarea>
        <button type="button" class="btn-ai-fill" id="btnAiFill">AI로 자동 채우기</button>
        <div class="ai-message" id="aiMessage" aria-live="polite"></div>
      </div>

      <div class="file-upload-wrap">
        <label>원본 PDF</label>
        <p class="file-hint">기본: <strong>소유권이전등기신청서(매매).pdf</strong> (이 HTML과 같은 폴더). 다른 양식을 쓰려면 선택하세요.</p>
        <input type="file" id="pdfFile" accept="application/pdf">
      </div>

      <h2>부동산 정보</h2>
      <div class="form-section">
        <div class="form-group">
          <label>소재지</label>
          <input type="text" id="address" placeholder="부동산 표시란">
        </div>
        <div class="form-group">
          <label>거래신고관리번호</label>
          <input type="text" id="reportNo">
        </div>
        <div class="form-group">
          <label>거래가액 (원)</label>
          <input type="text" id="price" placeholder="숫자 입력, 콤마 선택">
        </div>
      </div>

      <h2>등기원인 · 지분</h2>
      <div class="form-section">
        <div class="form-group">
          <label>등기원인 날짜</label>
          <div class="form-row">
            <input type="text" id="causeYear" placeholder="년" maxlength="4">
            <input type="text" id="causeMonth" placeholder="월" maxlength="2">
            <input type="text" id="causeDay" placeholder="일" maxlength="2">
          </div>
        </div>
        <div class="form-group">
          <label>이전할 지분</label>
          <input type="text" id="shareTransfer" placeholder="예: 1/1">
        </div>
      </div>

      <h2>등기의무자 (매도인)</h2>
      <div class="form-section">
        <div class="form-group">
          <label>성명</label>
          <input type="text" id="obligorName">
        </div>
        <div class="form-group">
          <label>주민등록번호</label>
          <input type="text" id="obligorJumin" placeholder="앞6자리-뒤7자리" maxlength="14">
        </div>
        <div class="form-group">
          <label>주소</label>
          <input type="text" id="obligorAddr">
        </div>
        <div class="form-group">
          <label>지분</label>
          <input type="text" id="obligorShare" placeholder="예: 1/1">
        </div>
      </div>

      <h2>등기권리자 (매수인)</h2>
      <div class="form-section">
        <div class="form-group">
          <label>성명</label>
          <input type="text" id="rightHolderName">
        </div>
        <div class="form-group">
          <label>주민등록번호</label>
          <input type="text" id="rightHolderJumin" placeholder="앞6자리-뒤7자리" maxlength="14">
        </div>
        <div class="form-group">
          <label>주소</label>
          <input type="text" id="rightHolderAddr">
        </div>
        <div class="form-group">
          <label>지분</label>
          <input type="text" id="rightHolderShare" placeholder="예: 1/1">
        </div>
      </div>

      <h2>세금 · 수수료</h2>
      <div class="form-section">
        <div class="form-group">
          <label>취득세 (원)</label>
          <input type="text" id="acquisitionTax">
        </div>
        <div class="form-group">
          <label>지방교육세 (원)</label>
          <input type="text" id="localEduTax">
        </div>
        <div class="form-group">
          <label>농어촌특별세 (원)</label>
          <input type="text" id="ruralTax">
        </div>
        <div class="form-group">
          <label>등기신청수수료 (원)</label>
          <input type="text" id="regFee">
        </div>
      </div>

      <h2>신청인</h2>
      <div class="form-section">
        <div class="form-group">
          <label>신청 날짜</label>
          <div class="form-row">
            <input type="text" id="appYear" placeholder="년" maxlength="4">
            <input type="text" id="appMonth" placeholder="월" maxlength="2">
            <input type="text" id="appDay" placeholder="일" maxlength="2">
          </div>
        </div>
        <div class="form-group">
          <label>신청인 성명</label>
          <input type="text" id="applicantName">
        </div>
      </div>
    </div>

    <div class="preview-panel">
      <div class="preview-placeholder" id="previewPlaceholder">기본 PDF를 불러오는 중…</div>
      <iframe id="pdfPreview" style="display: none;"></iframe>
    </div>
  </main>

  <footer class="footer">
    <button type="button" class="btn-download" id="btnDownload">PDF 생성 및 다운로드</button>
  </footer>

  <script>
    (function() {
      var fontUrl = 'https://fonts.gstatic.com/s/notosanskr/v27/PbyxFmXiEBPT4ITbgNA5Cgms3VYcOA-vvnIzzuoyeLTq8H4hfeE.woff2';
      var fontUrlTtf = 'https://cdn.jsdelivr.net/gh/google/fonts@main/ofl/notosanskr/NotoSansKR-Regular.ttf';
      var defaultPdfPath = '소유권이전등기신청서(매매).pdf';
      var cachedDefaultPdfBytes = null;
      var AI_STORAGE_KEY = '소유권이전등기_anthropic_api_key';
      var SYSTEM_PROMPT = '당신은 부동산 등기 문서 분석 전문가입니다.\n사용자의 자연어 입력에서 소유권이전등기신청서에 필요한 정보를 추출하세요.\n반드시 아래 JSON 형식으로만 응답하고 다른 텍스트는 절대 포함하지 마세요:\n{\n  "address": "소재지",\n  "reportNo": "거래신고관리번호",\n  "price": "거래가액(숫자와 콤마만)",\n  "causeYear": "등기원인년도",\n  "causeMonth": "등기원인월",\n  "causeDay": "등기원인일",\n  "shareTransfer": "이전할지분(없으면 1/1)",\n  "obligorName": "등기의무자(매도인)성명",\n  "obligorJumin": "등기의무자주민번호(없으면 빈값)",\n  "obligorAddr": "등기의무자주소",\n  "obligorShare": "등기의무자지분(없으면 1/1)",\n  "rightName": "등기권리자(매수인)성명",\n  "rightJumin": "등기권리자주민번호(없으면 빈값)",\n  "rightAddr": "등기권리자주소",\n  "rightShare": "등기권리자지분(없으면 1/1)",\n  "acqTax": "취득세(없으면 빈값)",\n  "eduTax": "지방교육세(없으면 빈값)",\n  "appYear": "신청년도",\n  "appMonth": "신청월",\n  "appDay": "신청일",\n  "court": "지방법원명(없으면 빈값)"\n}';

      function $(id) { return document.getElementById(id); }

      (function initApiKey() {
        try {
          var saved = localStorage.getItem(AI_STORAGE_KEY);
          if (saved && $('apiKey')) $('apiKey').value = saved;
        } catch (e) {}
        if ($('apiKey')) {
          $('apiKey').addEventListener('change', function() {
            try { localStorage.setItem(AI_STORAGE_KEY, this.value); } catch (e) {}
          });
          $('apiKey').addEventListener('input', function() {
            try { localStorage.setItem(AI_STORAGE_KEY, this.value); } catch (e) {}
          });
        }
      })();
      function formatJumin(val) {
        var s = String(val).replace(/[^0-9]/g, '').slice(0, 13);
        if (s.length <= 6) return s;
        return s.slice(0, 6) + '-' + s.slice(6);
      }
      $('obligorJumin').addEventListener('input', function() { this.value = formatJumin(this.value); });
      $('rightHolderJumin').addEventListener('input', function() { this.value = formatJumin(this.value); });

      function setEl(id, val) {
        var el = $(id);
        if (el && val != null && val !== '') el.value = String(val);
      }
      function showAiMessage(text, isError) {
        var el = $('aiMessage');
        if (!el) return;
        el.textContent = text;
        el.className = 'ai-message ' + (isError ? 'error' : 'success');
      }
      function extractJsonFromText(text) {
        var s = (text || '').trim();
        var m = s.match(/```(?:json)?\s*([\s\S]*?)```/);
        if (m) s = m[1].trim();
        return JSON.parse(s);
      }
      function fillFormFromData(data) {
        setEl('address', data.address);
        setEl('reportNo', data.reportNo);
        setEl('price', data.price);
        setEl('causeYear', data.causeYear);
        setEl('causeMonth', data.causeMonth);
        setEl('causeDay', data.causeDay);
        setEl('shareTransfer', data.shareTransfer || '1/1');
        setEl('obligorName', data.obligorName);
        setEl('obligorJumin', data.obligorJumin);
        setEl('obligorAddr', data.obligorAddr);
        setEl('obligorShare', data.obligorShare || '1/1');
        setEl('rightHolderName', data.rightName);
        setEl('rightHolderJumin', data.rightJumin);
        setEl('rightHolderAddr', data.rightAddr);
        setEl('rightHolderShare', data.rightShare || '1/1');
        setEl('acquisitionTax', data.acqTax);
        setEl('localEduTax', data.eduTax);
        setEl('appYear', data.appYear);
        setEl('appMonth', data.appMonth);
        setEl('appDay', data.appDay);
      }

      $('btnAiFill').addEventListener('click', async function() {
        var apiKey = ($('apiKey') && $('apiKey').value) ? $('apiKey').value.trim() : '';
        if (!apiKey) {
          showAiMessage('API 키를 입력해주세요.', true);
          return;
        }
        var userText = ($('aiInput') && $('aiInput').value) ? $('aiInput').value.trim() : '';
        var btn = $('btnAiFill');
        var msgEl = $('aiMessage');
        showAiMessage('', false);
        btn.disabled = true;
        btn.innerHTML = '<span class="ai-spinner"></span> 처리 중...';
        try {
          var res = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'x-api-key': apiKey,
              'anthropic-version': '2023-06-01',
              'content-type': 'application/json',
              'anthropic-dangerous-direct-browser-access': 'true'
            },
            body: JSON.stringify({
              model: 'claude-opus-4-6',
              max_tokens: 1024,
              system: SYSTEM_PROMPT,
              messages: [{ role: 'user', content: userText || '위 내용에서 등기 정보를 추출해 주세요.' }]
            })
          });
          if (!res.ok) {
            var errBody = await res.text();
            throw new Error(res.status === 401 ? 'API 키를 확인해주세요.' : (errBody || 'API 연결 실패'));
          }
          var json = await res.json();
          var text = (json.content && json.content[0] && json.content[0].text) ? json.content[0].text : '';
          if (!text) throw new Error('AI 응답이 비어 있습니다.');
          var data = extractJsonFromText(text);
          fillFormFromData(data);
          showAiMessage('✅ AI 자동입력 완료! 내용을 확인하고 수정하세요.', false);
        } catch (err) {
          var errMsg = (err && err.message) ? err.message : String(err);
          if (errMsg.includes('JSON') || errMsg.includes('parse') || errMsg.includes('Unexpected')) {
            showAiMessage('AI 응답 파싱 실패. 다시 시도해주세요.', true);
          } else if (errMsg.includes('Failed to fetch') || errMsg.includes('NetworkError')) {
            showAiMessage('API 연결 실패. 키를 확인해주세요.', true);
          } else {
            showAiMessage(errMsg, true);
          }
        } finally {
          btn.disabled = false;
          btn.textContent = 'AI로 자동 채우기';
        }
      });

      function showPdfInPreview(urlOrBlob) {
        var placeholder = $('previewPlaceholder');
        var iframe = $('pdfPreview');
        placeholder.style.display = 'none';
        iframe.style.display = 'block';
        iframe.src = urlOrBlob;
      }
      function showPlaceholder(msg) {
        var placeholder = $('previewPlaceholder');
        var iframe = $('pdfPreview');
        placeholder.style.display = 'block';
        placeholder.textContent = msg;
        iframe.style.display = 'none';
        iframe.src = '';
      }

      (function loadDefaultPdf() {
        fetch(defaultPdfPath)
          .then(function(r) { if (!r.ok) throw new Error(); return r.arrayBuffer(); })
          .then(function(buf) {
            cachedDefaultPdfBytes = buf;
            showPdfInPreview(defaultPdfPath);
          })
          .catch(function() {
            showPlaceholder('기본 PDF를 불러오지 못했습니다. 아래에서 「소유권이전등기신청서(매매).pdf」를 선택하거나, 이 HTML과 같은 폴더에 넣어 주세요.');
          });
      })();

      $('pdfFile').addEventListener('change', function() {
        var file = this.files[0];
        if (!file) {
          if (cachedDefaultPdfBytes) {
            showPdfInPreview(defaultPdfPath);
          } else {
            showPlaceholder('기본 PDF를 불러오지 못했습니다. 아래에서 파일을 선택하세요.');
          }
          return;
        }
        showPdfInPreview(URL.createObjectURL(file));
      });

      function getVal(id) { return ($(id) && $(id).value) ? String($(id).value).trim() : ''; }

      $('btnDownload').addEventListener('click', async function() {
        var fileInput = $('pdfFile');
        var pdfFile = fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;
        var bytes = null;
        var downloadName = '소유권이전등기신청서(매매)_작성완료.pdf';
        if (pdfFile) {
          bytes = await pdfFile.arrayBuffer();
          downloadName = (pdfFile.name && pdfFile.name.replace(/\.pdf$/i, '')) ? pdfFile.name.replace(/\.pdf$/i, '') + '_작성완료.pdf' : downloadName;
        } else if (cachedDefaultPdfBytes) {
          bytes = cachedDefaultPdfBytes;
        }
        if (!bytes) {
          alert('원본 PDF를 사용할 수 없습니다. 파일을 선택하거나, 소유권이전등기신청서(매매).pdf를 이 HTML과 같은 폴더에 넣어 주세요.');
          return;
        }
        var btn = this;
        btn.disabled = true;
        btn.textContent = '생성 중...';
        try {
          var pdfDoc = await PDFLib.PDFDocument.load(bytes);
          pdfDoc.registerFontkit(fontkit);

          var fontBytes;
          try {
            fontBytes = await fetch(fontUrl).then(function(r) { return r.arrayBuffer(); });
          } catch (e) {
            fontBytes = await fetch(fontUrlTtf).then(function(r) { return r.arrayBuffer(); });
          }
          var font = await pdfDoc.embedFont(fontBytes);
          var page = pdfDoc.getPage(0);
          var size = 9;

          var texts = [
            { v: getVal('address'),           x: 80,  y: 620 },
            { v: getVal('reportNo'),         x: 130, y: 480 },
            { v: getVal('price'),             x: 400, y: 480 },
            { v: getVal('causeYear'),         x: 200, y: 440 },
            { v: getVal('causeMonth'),        x: 270, y: 440 },
            { v: getVal('causeDay'),          x: 320, y: 440 },
            { v: getVal('shareTransfer'),     x: 200, y: 415 },
            { v: getVal('obligorName'),       x: 150, y: 370 },
            { v: getVal('obligorJumin'),      x: 250, y: 370 },
            { v: getVal('obligorAddr'),      x: 390, y: 370 },
            { v: getVal('obligorShare'),      x: 530, y: 370 },
            { v: getVal('rightHolderName'),   x: 150, y: 320 },
            { v: getVal('rightHolderJumin'),  x: 250, y: 320 },
            { v: getVal('rightHolderAddr'),   x: 390, y: 320 },
            { v: getVal('rightHolderShare'),  x: 530, y: 320 },
            { v: getVal('acquisitionTax'),    x: 130, y: 270 },
            { v: getVal('localEduTax'),       x: 250, y: 270 },
            { v: getVal('ruralTax'),         x: 370, y: 270 },
            { v: getVal('regFee'),            x: 480, y: 270 },
            { v: getVal('appYear'),           x: 200, y: 180 },
            { v: getVal('appMonth'),          x: 270, y: 180 },
            { v: getVal('appDay'),            x: 320, y: 180 },
            { v: getVal('applicantName'),     x: 350, y: 130 }
          ];

          for (var i = 0; i < texts.length; i++) {
            if (texts[i].v) {
              page.drawText(texts[i].v, {
                x: texts[i].x,
                y: texts[i].y,
                size: size,
                font: font
              });
            }
          }

          var pdfBytes = await pdfDoc.save();
          var blob = new Blob([pdfBytes], { type: 'application/pdf' });
          download(blob, downloadName, 'application/pdf');
        } catch (err) {
          console.error(err);
          alert('PDF 생성 중 오류가 났습니다. 콘솔을 확인해 주세요.\n' + (err && err.message ? err.message : String(err)));
        } finally {
          btn.disabled = false;
          btn.textContent = 'PDF 생성 및 다운로드';
        }
      });
    })();
  </script>
</body>
</html>
